<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat with Context</title>
    <style>
      :root {
        color-scheme: light;
        --bg-start: #f5f1e8;
        --bg-end: #e4f0f3;
        --ink: #1e1e1e;
        --muted: #5b5b5b;
        --accent: #1e6d5a;
        --accent-soft: #cfe7de;
        --panel: #ffffff;
        --panel-edge: #d9d4c8;
        --warning: #b14d1c;
        --shadow: 0 12px 30px rgba(15, 18, 25, 0.12);
        --mono: "Cascadia Mono", "Consolas", "Courier New", monospace;
        --sans: "Trebuchet MS", "Segoe UI", sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: var(--sans);
        color: var(--ink);
        background: linear-gradient(135deg, var(--bg-start), var(--bg-end));
      }

      .layout {
        max-width: 1100px;
        margin: 0 auto;
        padding: 28px 20px 40px;
        display: grid;
        gap: 20px;
        grid-template-columns: 1fr;
        grid-template-areas:
          "header"
          "chat"
          "debug";
        animation: fade-in 0.4s ease-out;
      }

      @media (min-width: 960px) {
        .layout {
          grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
          grid-template-areas:
            "header header"
            "chat debug";
        }
      }

      header {
        grid-area: header;
        background: var(--panel);
        border: 1px solid var(--panel-edge);
        border-radius: 18px;
        padding: 20px 24px;
        box-shadow: var(--shadow);
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      header h1 {
        margin: 0 0 6px 0;
        font-size: 24px;
        letter-spacing: 0.4px;
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .session-pill {
        display: inline-flex;
        flex-direction: column;
        gap: 4px;
        padding: 10px 14px;
        border-radius: 14px;
        background: var(--accent-soft);
        color: var(--accent);
        font-weight: 600;
        min-width: 220px;
      }

      .session-pill span {
        font-size: 12px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      .session-pill strong {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--ink);
        word-break: break-all;
      }

      .chat-panel {
        grid-area: chat;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .messages {
        background: var(--panel);
        border: 1px solid var(--panel-edge);
        border-radius: 18px;
        padding: 16px;
        min-height: 260px;
        max-height: 420px;
        overflow-y: auto;
        box-shadow: var(--shadow);
      }

      .messages .empty {
        color: var(--muted);
        text-align: center;
        padding: 40px 0;
        font-size: 14px;
      }

      .message {
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid transparent;
        margin-bottom: 12px;
        animation: slide-in 0.25s ease-out;
      }

      .message:last-child {
        margin-bottom: 0;
      }

      .message.user {
        background: #eaf5f0;
        border-color: #b8d8cf;
      }

      .message.assistant {
        background: #f7f2e7;
        border-color: #e2d2b2;
      }

      .message .meta {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.7px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .message pre {
        margin: 0;
        font-family: var(--sans);
        white-space: pre-wrap;
        word-break: break-word;
      }

      .composer {
        background: var(--panel);
        border: 1px solid var(--panel-edge);
        border-radius: 18px;
        padding: 14px;
        box-shadow: var(--shadow);
        display: grid;
        gap: 12px;
      }

      textarea {
        width: 100%;
        resize: vertical;
        min-height: 90px;
        border-radius: 12px;
        border: 1px solid #c9c2b3;
        padding: 10px 12px;
        font-family: var(--sans);
        font-size: 14px;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      button {
        border: none;
        border-radius: 999px;
        padding: 10px 18px;
        font-weight: 600;
        background: var(--accent);
        color: #ffffff;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 8px 16px rgba(30, 109, 90, 0.18);
      }

      button.secondary {
        background: #f0e6d3;
        color: #3b2f1b;
        box-shadow: none;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .debug-panel {
        grid-area: debug;
        background: var(--panel);
        border: 1px solid var(--panel-edge);
        border-radius: 18px;
        padding: 16px;
        box-shadow: var(--shadow);
        display: grid;
        gap: 12px;
      }

      .debug-panel h2 {
        margin: 0;
        font-size: 16px;
      }

      .debug-block {
        border: 1px solid #e2dbce;
        border-radius: 12px;
        padding: 10px 12px;
        background: #fbf9f4;
      }

      .debug-block h3 {
        margin: 0 0 6px 0;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        color: var(--muted);
      }

      .debug-block pre {
        margin: 0;
        font-family: var(--mono);
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .debug-block .status {
        font-family: var(--mono);
        font-size: 12px;
      }

      .debug-block .error {
        color: var(--warning);
        font-family: var(--mono);
        font-size: 12px;
      }

      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slide-in {
        from {
          opacity: 0;
          transform: translateX(-6px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
    </style>
  </head>
  <body>
    <main class="layout">
      <header>
        <div>
          <h1>Chat with Context</h1>
          <p>Stateful chat test page for /api/chat/send</p>
        </div>
        <div class="session-pill">
          <span>Conversation ID</span>
          <strong id="conversationId">(new)</strong>
        </div>
      </header>

      <section class="chat-panel">
        <div id="messages" class="messages"></div>
        <div class="composer">
          <textarea id="userInput" placeholder="Type a message"></textarea>
          <div class="actions">
            <button id="sendBtn" type="button">Send</button>
            <button id="newSessionBtn" type="button" class="secondary">New Session</button>
          </div>
        </div>
      </section>

      <aside class="debug-panel">
        <h2>Debug</h2>
        <div class="debug-block">
          <h3>Request JSON</h3>
          <pre id="debugRequest"></pre>
        </div>
        <div class="debug-block">
          <h3>Response JSON</h3>
          <pre id="debugResponse"></pre>
        </div>
        <div class="debug-block">
          <h3>Status</h3>
          <div id="debugStatus" class="status"></div>
        </div>
        <div class="debug-block">
          <h3>Error</h3>
          <div id="debugError" class="error"></div>
        </div>
      </aside>
    </main>

    <script>
      const STORAGE_CONVERSATION_ID = "chat_history_conversation_id";
      const STORAGE_MESSAGES = "chat_history_messages";
      const state = { conversationId: "", messages: [] };

      const messagesEl = document.getElementById("messages");
      const conversationIdEl = document.getElementById("conversationId");
      const inputEl = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");
      const newSessionBtn = document.getElementById("newSessionBtn");
      const debugRequestEl = document.getElementById("debugRequest");
      const debugResponseEl = document.getElementById("debugResponse");
      const debugStatusEl = document.getElementById("debugStatus");
      const debugErrorEl = document.getElementById("debugError");

      function loadState() {
        const storedId = localStorage.getItem(STORAGE_CONVERSATION_ID) || "";
        let storedMessages = [];
        const rawMessages = localStorage.getItem(STORAGE_MESSAGES);
        if (rawMessages) {
          try {
            const parsed = JSON.parse(rawMessages);
            if (Array.isArray(parsed)) {
              storedMessages = parsed
                .filter((item) => item && typeof item.text === "string")
                .map((item) => ({
                  role: item.role === "assistant" ? "assistant" : "user",
                  text: item.text,
                  ts: typeof item.ts === "number" ? item.ts : Date.now(),
                }));
            }
          } catch (err) {
            storedMessages = [];
          }
        }

        state.messages = storedMessages;
        setConversationId(storedId);
        renderMessages(state.messages);
      }

      function saveState() {
        localStorage.setItem(STORAGE_CONVERSATION_ID, state.conversationId);
        localStorage.setItem(STORAGE_MESSAGES, JSON.stringify(state.messages));
      }

      function renderMessages(messages) {
        messagesEl.innerHTML = "";
        if (!messages.length) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "No messages yet.";
          messagesEl.appendChild(empty);
          return;
        }

        for (const msg of messages) {
          const item = document.createElement("div");
          item.className = `message ${msg.role}`;
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = msg.role === "assistant" ? "Assistant" : "User";
          const body = document.createElement("pre");
          body.textContent = msg.text;
          item.appendChild(meta);
          item.appendChild(body);
          messagesEl.appendChild(item);
        }
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function setConversationId(id) {
        const cleaned = (id || "").trim();
        state.conversationId = cleaned;
        conversationIdEl.textContent = cleaned || "(new)";
        localStorage.setItem(STORAGE_CONVERSATION_ID, cleaned);
      }

      function buildRequestBody(userText, conversationId) {
        const body = { user_text: userText };
        if (conversationId && conversationId.trim()) {
          body.conversation_id = conversationId.trim();
        }
        return body;
      }

      async function sendToApi(body) {
        const start = performance.now();
        try {
          const response = await fetch("/api/chat/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const rawText = await response.text();
          let json = null;
          try {
            json = JSON.parse(rawText);
          } catch (err) {
            json = null;
          }
          const ms = Math.round(performance.now() - start);
          return { ok: response.ok, status: response.status, ms, json, rawText };
        } catch (err) {
          const ms = Math.round(performance.now() - start);
          return { ok: false, status: 0, ms, json: null, rawText: "", error: String(err) };
        }
      }

      function updateDebugRequest(body) {
        debugRequestEl.textContent = JSON.stringify(body, null, 2);
      }

      function updateDebugResponse(result) {
        if (result.json) {
          debugResponseEl.textContent = JSON.stringify(result.json, null, 2);
          return;
        }
        debugResponseEl.textContent = result.rawText || "";
      }

      function updateDebugStatus(result) {
        if (result.status === 0) {
          debugStatusEl.textContent = `NETWORK ERROR (${result.ms} ms)`;
        } else {
          debugStatusEl.textContent = `HTTP ${result.status} (${result.ms} ms)`;
        }
      }

      function updateDebugError(result) {
        if (result.ok) {
          debugErrorEl.textContent = "";
          return;
        }
        if (result.error) {
          debugErrorEl.textContent = result.error;
          return;
        }
        debugErrorEl.textContent = result.rawText || "Request failed.";
      }

      async function handleSend() {
        const userText = inputEl.value.trim();
        if (!userText || sendBtn.disabled) {
          return;
        }

        sendBtn.disabled = true;
        const body = buildRequestBody(userText, state.conversationId);
        updateDebugRequest(body);
        debugResponseEl.textContent = "";
        debugStatusEl.textContent = "Sending...";
        debugErrorEl.textContent = "";

        const result = await sendToApi(body);
        updateDebugResponse(result);
        updateDebugStatus(result);
        updateDebugError(result);

        if (result.ok && result.json) {
          const conversationId =
            typeof result.json.conversation_id === "string"
              ? result.json.conversation_id
              : "";
          const assistantText =
            typeof result.json.assistant_text === "string"
              ? result.json.assistant_text
              : "";
          if (conversationId) {
            setConversationId(conversationId);
          }
          state.messages.push({ role: "user", text: userText, ts: Date.now() });
          if (assistantText) {
            state.messages.push({ role: "assistant", text: assistantText, ts: Date.now() });
          }
          renderMessages(state.messages);
          saveState();
          inputEl.value = "";
        }

        sendBtn.disabled = false;
      }

      function handleNewSession() {
        state.messages = [];
        renderMessages(state.messages);
        setConversationId("");
        saveState();
        debugRequestEl.textContent = "";
        debugResponseEl.textContent = "";
        debugStatusEl.textContent = "";
        debugErrorEl.textContent = "";
      }

      sendBtn.addEventListener("click", handleSend);
      newSessionBtn.addEventListener("click", handleNewSession);

      loadState();
    </script>
  </body>
</html>
