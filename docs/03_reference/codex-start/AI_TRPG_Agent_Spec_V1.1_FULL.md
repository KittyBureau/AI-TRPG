# AI 跑团产品 Agent Spec（V1.1 · 完整版）
日期：2026-01-14

> 状态：**冻结 · 实现基线**  
> 说明：本文件是 AI Agent / Codex / Cursor Agent 的**唯一行为与接口规范**。  
> 若与 PRD-lite 冲突，以本文件为准（实现层面）。

---

## 1. Agent 总体职责

### 1.1 Agent 是什么
Agent 是“AI 跑团主持人（GM）”，其职责是：
- 叙事与描述世界
- 判断当前对话语义类型
- 提出玩家可选行动
- 提出对系统状态的**修改请求**（通过工具）

### 1.2 Agent 不是什么
Agent **不是**：
- 状态裁决者
- 规则修改者
- 世界观或角色卡的编辑者
- 存储系统的直接操作者

---

## 2. 核心硬规则（不可违背）

1. **权威状态优先**
   - 血量、位置、存活状态、世界规则、地图结构、角色卡字段均以系统数据为准。
2. **AI 只请求，不裁决**
   - AI 可以请求工具或状态变更，但是否生效由系统裁决。
3. **对话类型自动判断**
   - Agent 必须在每个 Turn 判断当前对话类型。
4. **冲突必须可检测**
   - Agent 输出不得与权威状态直接冲突，否则会被拦截并要求修正。

---

## 3. Turn（回合）协议

### 3.1 Turn 定义
一次 Turn 是：

玩家输入 → Agent 推理 → Agent 输出 →（可选）工具请求 → 系统裁决 → 状态落盘

### 3.2 Turn 必须包含的信息
- 当前行动者（actor）
- 当前对话类型（dialog_type）
- 叙事文本（text）
- 可选：结构化工具请求（tool_calls）

---

## 4. 对话类型（Dialog Type）规范

### 4.1 对话类型枚举（可扩展）
Agent 必须从以下类型中选择其一（字符串值）：

- scene_description：场景/信息描述  
- action_prompt：事件推进，给出可行动选项  
- resolution_summary：事件或阶段总结  
- rule_explanation：规则说明  

### 4.2 对话类型语义约束

#### scene_description
- 只描述，不推进时间
- 不得修改任何权威状态

#### action_prompt
- 必须给出玩家可执行的行动方向
- 不得自行结算结果

#### resolution_summary
- 总结已发生的、**系统已确认**的事件
- 不得引入新状态变化

#### rule_explanation
- 解释当前战役规则
- 不得生成新规则

---

## 5. 状态机交互规范

### 5.1 状态集合（语义）
- alive：正常行动
- dying：濒死，仅可对话
- unconscious：昏迷，不可行动
- restrained_permanent：永久限制自由（战役结束）
- dead：死亡（多人需全灭）

### 5.2 Agent 在状态机中的权限
- Agent **可以请求**任意状态切换
- Agent **不能宣告**状态切换已生效

### 5.3 状态切换表达要求
- 状态切换只能通过**结构化请求**表达
- 禁止仅通过叙事文本宣告状态变化

---

## 6. 工具（Tool / Action）协议

### 6.1 总体原则
- Agent 可在任意 Turn 请求工具
- 工具请求是“建议”，不是“命令”

### 6.2 工具请求统一结构
{
  "tool": "move | hp_delta | map_generate | ...",
  "args": { },
  "reason": "自然语言理由（可选）",
  "id": "unique_call_id"
}

### 6.3 V1 允许请求的工具

#### move
- 语义：角色从一个区域移动到另一个区域
- 必备参数：actor_id, to_area_id（from_area_id 由后端根据当前 position 计算）
- 破坏性变更：move tool_call args 中包含 from_area_id 将返回 invalid_args

#### hp_delta
- 语义：修改指定角色血量
- 必备参数：target_character_id, delta, cause

#### map_generate
- 语义：生成子层级地图
- 必备参数：parent_area_id, theme/constraints

---

## 7. 工具执行反馈（系统 → Agent）

### 7.1 成功反馈
- 返回执行结果与权威状态摘要

### 7.2 失败反馈
{
  "failed_calls": [
    {
      "id": "call_001",
      "tool": "move",
      "status": "rejected | error",
      "reason": "区域移动锁未解除"
    }
  ]
}

### 7.3 Agent 义务
- 必须根据反馈调整行为
- 不得重复非法请求

---

## 8. 冲突与重试协议

### 8.1 冲突定义
- 叙事与权威状态不一致
- 越权修改规则、地图或角色卡

### 8.2 冲突处理
- 拦截输出
- 附加 debug
- 限制重试次数

---

## 9. 里程碑与节奏

- Agent 需感知是否处于加速阶段
- 加速阶段需加强事件推进，但不得越权

---

## 10. 禁止行为（黑名单）

- 改写世界观
- 改写角色卡
- 宣告未确认状态变化

---

## 11. 扩展要求

新增工具必须：
- 更新本 Spec
- 定义裁决与失败条件

---

## 12. 结论

本文件是 AI 行为与工具交互的**唯一规范**。
