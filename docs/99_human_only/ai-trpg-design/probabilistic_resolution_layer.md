# 概率裁定层（D20｜可选模块）

> 目的：在不改变“主线里程碑门槛”的前提下，引入可计算的成功率；  
> 约束：**本模块是可选的**，用于“允许数值/骰子”的版本；若某次跑团设定禁用骰子/数值，请不要启用它。

## 1) 角色能力（由外部工具提供）
- 能力值/技能值如何得到：由你的外部工具/系统负责。
- 本模块只需要外部工具返回一个：`ability_mod`（能力修正值，整数，可为负）。
- 可选：`proficiency_mod`、`advantage_state`（优势/劣势/无）。

## 2) 选项成功率（只由 GM/AI 提供）
当玩家面对多个选项时，GM/AI **只提供每个选项的目标成功率** `p_success`（0–1），例如：
- 保守/主线强相关：`p_success = 0.70`
- 中等风险/相关：`p_success = 0.55`
- 高风险/弱相关但可能爆线索：`p_success = 0.30`

> 说明：GM/AI 不直接给 DC、不掷骰、不算能力；这些由工具链完成。

## 3) 从成功率反推 DC（由外部工具计算）
令 `roll` 为 1–20 的均匀随机数（D20），成功条件为：
`roll + ability_mod >= DC`

### 3.1 无优势/劣势（最常用）
成功率为：
`P(success) = clamp((21 - (DC - ability_mod)) / 20, 0, 1)`

由 `p_success` 反推一个整数 DC（取最接近、或取“向上取整更保守”）：
`DC ≈ ability_mod + 21 - 20 * p_success`

外部工具建议实现：
- `DC = ceil(ability_mod + 21 - 20 * p_success)`
- 并将 `DC` clamp 到 `[1, 30]`（允许非常难的检定，不必限制到 20）

### 3.2 优势/劣势（可选）
- 优势：`P_adv = 1 - (1 - P)^2`
- 劣势：`P_dis = P^2`

外部工具做法：先用 `p_success` 求出无优势时需要的 `P`（反解），再按 3.1 反推 DC。

## 4) 结果分级（对接你的“成功/部分成功/失败”叙事）
外部工具给出 `roll` 与 `total = roll + ability_mod` 后，GM/AI只做分级叙事：
- 成功：`total >= DC`
- 部分成功：`DC - 2 <= total < DC`（差 1–2 点，推进但带代价/新问题）
- 失败：`total < DC - 2`

> 可按项目调整“部分成功”窗口宽度（例如 1 点或 3 点），但要保持一致。

## 5) 与主线里程碑的关系（硬门槛仍然生效）
- 检定只能用于“补齐当前里程碑门槛”的行动：  
  - 命中 → 获得“里程碑碎片”（时间窗、单位抬头、编号段、中心点描述等）  
  - 未命中 → 触发现实护栏/风险复利，但依然把玩家拉回“补齐门槛”的选项面
- 不允许用一次高骰直接跳过多个里程碑：最多推进到“下一步门槛刚好满足”。

## 6) 异常行为的特殊效果（概率与代价绑定）
当玩家采取“看似异常”的动作，但它可能导向里程碑完成：
- GM/AI 可以给出较低 `p_success`（例如 0.25–0.40）
- 外部工具照常反推 DC 并掷骰
- 若命中：直接给“关键碎片”（强回流）
- 若未命中：风险复利加速（例如异常累计 +1，并触发更硬的现实护栏）

