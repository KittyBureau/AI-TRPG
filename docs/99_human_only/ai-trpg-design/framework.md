# AI 跑团游戏框架（可扩展｜多 Agent｜可选概率裁定）

> 目标：把“叙事跑团”拆成可组合的模块：对话叙事、状态记录、主线门槛、风险护栏、工具计算、压缩重启。  
> 说明：框架不绑定具体世界观；可用现代现实、科幻、悬疑等作为实例化配置。

---

## 1. 关键设计原则

### 1.1 主线可控（Milestone-Gated）
- 主线被拆成若干“里程碑（Milestones）”，每个里程碑都有**可验证完成条件**。
- **未完成当前里程碑，不放出下一步主线内容**；只给“补齐门槛”的选项。
- 允许偏离，但偏离必须被**矫正回流**（见第 6 章）。

### 1.2 记忆可控（可压缩、可重启）
- 长期记忆只保留：公开事实、关系变化、不可逆后果（可按项目自定义）。
- 每完成一个里程碑立刻写“压缩摘要”，重启上下文时只加载摘要即可继续。

### 1.3 风险可见（现实护栏 + 复利式升级）
- 用“现实会如何反应”作为护栏（执法、路人传播、经济、账号风控等）。
- 维护“异常累计”作为后台变量：越偏离、越频繁，后果越快、越重（近似指数增长）。
- 可以设计“结束游戏级后果阈值”（例如被带离/封存丢失/权限冻结）。

### 1.4 概率可选（D20 层不破坏主线门槛）
- 概率裁定仅用于“补齐门槛”的动作：命中→获得里程碑碎片；未命中→风险复利 + 回到门槛选项面。
- 成功率由 GM/AI 给出；能力值与掷骰由外部工具提供与执行。

---

## 2. 多 Agent 分工（职责隔离）

> 推荐做法：一个 Orchestrator（调度器）+ 多个专职 Agent；小项目也可合并成单 Agent 的不同“内部段落”。

### 2.1 GM / 对话叙事 Agent（玩家可见输出）
- 职责：
  - 叙事推进：描述局势 → 引入新压力 → 提问“你打算做什么？”
  - 给出可选行动（3–6 个），并说明每个选择的风险/代价（可见）。
  - 若启用概率：仅提供每个选项的目标成功率 `p_success`（不掷骰、不算能力）。
- 约束：
  - 不泄露内部状态表/门槛计数/异常累计。
  - 不替玩家总结意义，只给事实与后果。

### 2.2 State Tracker / 世界状态记录 Agent（内部）
- 职责：
  - 维护可持久化状态：公开事实、势力态度、风险档位、未解决问题、不可逆后果。
  - 每轮结束更新；每个里程碑完成写压缩摘要。
  - 输出给 Orchestrator 的是“可用状态片段”（避免塞满上下文）。

### 2.3 Mainline Controller / 主线门槛 Agent（内部）
- 职责：
  - 定义当前里程碑与完成条件；检查玩家行动是否补齐门槛。
  - 若偏离：生成“矫正方案”（现实阻拦/代价兑现/回流碎片/替代行动）。
  - 维护“异常累计”“信息焦点”等护栏状态（或交给 Guard Agent）。

### 2.4 Guard / 现实护栏与风险 Agent（内部）
- 职责：
  - 将玩家行为映射到现实护栏：执法、路人传播、经济、系统风控、组织流程、身心状态等。
  - 触发可见信号与后果；驱动风险复利（异常累计）。
  - 当达到终局阈值，触发结束游戏级后果并转入冻结复盘流程。

### 2.5 Resolver / 计算与概率裁定 Agent（工具编排）
- 职责：
  - 接收 GM 给的 `p_success` 与外部工具返回的 `ability_mod`、`roll`。
  - 由外部工具反推 DC、完成掷骰、返回结构化结果（成功/部分成功/失败）。
  - 只把“结果分级 + 需要叙事的关键点”交回 GM。

### 2.6 Design Observer / 设计观察员（离线复盘）
- 职责：
  - 记录“系统支持需求”与“模型卡住点”：哪里需要更好的工具、更清晰的门槛、更强的护栏。
  - 在冻结后输出：哪些信息该长期保存、哪些适合遗忘、哪些机制该系统化。

---

## 3. 工具链（Toolchain）与接口契约

### 3.1 最小工具集（建议）
- `load_session_state()`：加载状态（JSON/Markdown 均可）。
- `save_session_state(state)`：保存状态快照。
- `append_turn_log(entry)`：追加回合日志（供审计与回放）。
- `append_milestone_summary(summary)`：追加里程碑压缩摘要。

### 3.2 概率裁定工具（可选）
- `get_ability_mod(player_id, check_type)` → `ability_mod`
- `roll_d20(advantage_state)` → `roll`（或返回两次骰结果）
- `dc_from_p(p_success, ability_mod, advantage_state)` → `DC`
- `grade_result(roll, ability_mod, DC)` → `{grade: success|partial|fail, margin}`

> 关键约束：GM/AI 只提供 `p_success`；能力需求与掷骰必须外部化，避免模型“自我掷骰”。

### 3.3 信息安全与合规（建议）
- 工具记录应支持“脱敏写入”：对外日志不包含敏感人名/具体地址（按项目设定）。
- 风险升级与终局触发的规则在工具侧可审计（便于测试与回放）。

---

## 4. 提示词（Prompt Stack）建议

### 4.1 全局 System Prompt（高层约束）
应包含：
- 题材与禁区（例如现实/无超自然、或科幻/允许高科技等）
- 是否启用数值与骰子（禁用时强制叙事裁定；启用时走 Resolver）
- 记忆策略：允许长期保留哪些信息、必须遗忘哪些信息
- 回合结构：每轮固定三段（局势→压力→提问）
- 冻结规则：达到 N 轮或触发终局后输出“剧情冻结，用于分析”，进入复盘问题

### 4.2 GM Prompt（对话层）
应包含：
- 输出格式：每轮只输出玩家可见内容 + 可选行动 + “你现在打算做什么？”
- 不泄露内部状态；不输出表格状态（可内部写文件/状态）
- 每个选项至少给：目标、风险、可能代价（启用概率时附 `p_success` 给 Resolver）

### 4.3 State Tracker Prompt（状态层）
应包含：
- 只写结构化状态：事实/关系/不可逆后果/风险档位/未解问题
- 每轮结束必须更新一次；里程碑完成必须写压缩摘要
- 严禁把临时推理/对话原句长期保留（除非项目允许）

### 4.4 Guard Prompt（护栏层）
应包含：
- 异常累计触发条件清单与复利兑现规则
- 现实护栏库（执法/路人/经济/系统风控…）的触发与后果模板
- 终局触发阈值与结局选项（三选一保全等）

---

## 5. 数据结构（建议抽象）

### 5.1 SessionConfig
- `setting_profile`：世界观配置（现代/科幻/末日/校园…）
- `tone`：叙事风格（冷静/纪实/黑色幽默…）
- `ruleset`：是否启用概率裁定、部分成功窗口、是否允许玩家能力成长
- `freeze_policy`：轮数上限、终局触发策略

### 5.2 WorldState（可持久化）
- `public_facts[]`
- `relationships[]`
- `irreversible_consequences[]`
- `factions[]`（态度：支持/中立/敌对等）
- `risk_tier`（文字档位）
- `info_clarity_tier`（清晰/模糊/断续/丢失）
- `open_questions[]`

### 5.3 MainlineState
- `current_milestone_id`
- `milestone_progress`（已获得的碎片/证据锚点）
- `abnormal_counter`（异常累计，内部）
- `endgame_triggered`（是否已触发终局）

### 5.4 Logs
- `turn_log`：每轮内部摘要（可详细）
- `milestone_log`：里程碑压缩摘要（可重启用）

---

## 6. 主线门槛与偏离矫正（核心控制面）

### 6.1 里程碑推进规则
- GM 每次准备放出“下一步剧情”前，先由 Mainline Controller 检查：当前里程碑是否完成。
- 未完成：只允许给“补齐门槛”的选项（并解释现实理由：证据不足会误导、风险过高会被拦、窗口将封存等）。

### 6.2 偏离矫正的四种常用手段
- 现实阻拦：围挡/门禁/执法要求，让偏离行动无法继续深化。
- 代价兑现：盘问/登记/账号验证等，让玩家“感到代价”，并把玩家推回主线任务面。
- 回流碎片：即使偏离，也尽量产出一个能回到里程碑的碎片（单位抬头/编号段/时间窗）。
- 明确替代：给一个“同目标但更主线、更低风险”的替代行动。

### 6.3 “异常累计”与终局
- 异常累计越高，同样行为触发的后果越快越重（复利式升级）。
- 达到阈值：触发结束游戏级后果（被带离/封存丢失/权限冻结），并进入冻结复盘。

---

## 7. 概率裁定层（可选）如何接入

### 7.1 GM 侧：只给成功率
- 每个选项给一个 `p_success`（示例：0.70/0.55/0.30）。
- 这些成功率体现“动作是否合理、信息是否可核对、环境风险是否干扰”，但不暴露内部 DC。

### 7.2 工具/Resolver 侧：计算与掷骰
- 外部工具提供 `ability_mod` 与 `roll`（D20）。
- 工具根据 `p_success` 反推 DC，算出成功/部分成功/失败分级。

### 7.3 特殊行为的“爆线索可能”
- 看似异常的动作，如果可能完成当前里程碑：给较低 `p_success`，命中就直接产出关键碎片；未命中则异常累计加速。

---

## 8. 冻结与复盘（Design Debrief）

### 8.1 冻结触发
- 达到设定轮数（例如 3–5 轮）或触发终局阈值，立即输出冻结句并停止推进。

### 8.2 复盘输出（建议问题）
- 本次最依赖的能力（信息整合/社交/风险判断/推理…）
- 哪些地方需要系统支持（记录、检定、风险提示、里程碑门槛…）
- 哪些信息应长期保存/应遗忘
- 最需要系统化的三点与不适合系统化的部分

---

## 9. 参考实现（本仓库已有的可复用模块）

> 以下文件是具体机制的实例化，可直接改写成你自己的“系统包”：
- `mainline_milestones.md`：里程碑门槛、偏离矫正、终局触发、特殊效果可能性
- `mainline_protection_mechanism.md`：信息焦点/风险阶梯/复利式升级
- `reality_guards.md`：现实世界护栏库（执法、路人传播、经济、系统风控…）
- `probabilistic_resolution_layer.md`：可选 D20 概率裁定层（成功率由 GM 提供，计算与掷骰外部化）
- `../runs/2026-01-06_trpg_test/milestone_log.md`：按里程碑压缩的可重启记录格式（示例）
- `../runs/2026-01-06_trpg_test/internal_notes.md`：一次完整跑团的内部记录（示例）
